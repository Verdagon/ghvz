<dom-module id="ghvz-static-map">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-static-map',

        properties: {
          latitude: Number,
          longitude: Number,

          messageId: {
            type: String,
            value: 'dialog', // The only map without a message id is the send location dialog map
          }, 

          mapContainerName: String,
        },

        observers: [
          'onMessageIdSet_(messageId)',
          'onLatLongChange_(latitude, longitude)',
        ],

        onMessageIdSet_() {
          if (this.messageId) {
            this.mapContainerName = "static-map-" + this.messageId;
          } else {
            this.mapContainerName = "static-map-dialog";
          }
        },

        onLatLongChange_() {
          let displayedImage = this.$$("#" + this.mapContainerName).src;
          if (this.latitude && this.longitude) {
            var latlon = this.latitude + "," + this.longitude;

            var mapImageUrl = "https://maps.googleapis.com/maps/api/staticmap" 
              + "?center=" + latlon 
              + "&size=200x200&" 
              + "markers=|" + latlon 
              + "&key=AIzaSyBLcysHAt2T64FEilpUEUlrJ34hrEY19cQ";

            // Update the image element to show the map
            this.$$("#" + this.mapContainerName).src = mapImageUrl;
          } else if (displayedImage != 'https://goo.gl/EJ3MGp') {
            // Update the image element to show the nerf loading screen
            this.$$("#" + this.mapContainerName).src = 'https://goo.gl/EJ3MGp';
          }
        },
      });
    });
  </script>
  <style include="iron-flex iron-flex-alignment">
    :host {
      display: block;
    }
    .map-container {
      width: 200px;
      height: 200px;
    }
  </style>
  <template>
    <img id$="[[mapContainerName]]" class="map-container" src="https://goo.gl/EJ3MGp"></img>
  </template>
</dom-module>