<dom-module id="ghvz-population-current">
<script>
  // Not sure why this HTMLImports.whenReady is really needed.
  // Something about polymer initialization order.
  // I think we're not supposed to need this.
  HTMLImports.whenReady(() => {
    Polymer({
      is: 'ghvz-population-current',

      properties: {
        game: Object,
        chartLoaded: {
          type: Boolean,
          value: undefined,
        }
      },

      attached() {
        google.charts.setOnLoadCallback(() => this.setChartLoaded());

        // The following makes Google Charts responsive and will resize the chart
        // as the page is resized. 
        var lastResize; // closure property for debouncing
        window.addEventListener('resize', () => { 
          if (lastResize) {
            window.clearTimeout(this.lastResize);
          }

          lastResize = window.setTimeout(() => {
            this.drawCurrentPopulationChart();
          }, 200)
        });
      },

      setChartLoaded() {
        this.chartLoaded = true;
      },

      observers: [
        'drawCurrentPopulationChart(chartLoaded, game)',
      ],

      lastResize: null,

      drawCurrentPopulationChart: function() {
        var numZombies = 0;
        var numHumans = 0;
        for (let player of this.game.players) {
          numZombies += player.allegiance == 'horde';
          numHumans += player.allegiance == 'resistance';
        }

        // update hidden nodes for testing
        this.$.zombie_count.textContent = numZombies;
        this.$.humans_count.textContent = numHumans;

        var data = google.visualization.arrayToDataTable([
          ['Type', 'Number'],
          ['Human',  numHumans],
          ['Zombie',  numZombies],
          ]);

        var options = {
          title: "Current Population",
          legend: { position: 'right' }
        };

        // ensure old dom is cleared out
        this.$.current_population_chart.textContent = '';
        var chart = new google.visualization.PieChart(
          this.$.current_population_chart);

        chart.draw(data, options);
      }
    });
  });
</script>
<style>
  .hidden {
    width: 0;
    height: 0;
    overflow: hidden;
  }
</style>
<template>
  <div id="current_population_chart" style="width: 100%, height: 100%"></div>
  <div id="current_population_meta" class="hidden">
    <div id="zombie_count"></div>
    <div id="humans_count"></div>
  </div>
</template>
</dom-module>
